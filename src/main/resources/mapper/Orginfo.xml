<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sundata.edu.dao.OrginfoDao">

    <resultMap type="com.sundata.edu.domain.Orginfo" id="BaseResultMap">
        <result property="orgId" column="org_id"/>
        <result property="parentOrgId" column="parent_org_id"/>
        <result property="orgName" column="org_name"/>
        <result property="status" column="status"/>
        <result property="leaders" column="leaders"/>
        <result property="telephone" column="telephone"/>
        <result property="peopleNum" column="people_num"/>
        <result property="leadersNum" column="leaders_num"/>
        <result property="teacherNum" column="teacher_num"/>
        <result property="logisticsNum" column="logistics_num"/>
        <result property="studentNum" column="student_num"/>
        <result property="classNum" column="class_num"/>
        <result property="technologySanctionedNum" column="technology_sanctioned_num"/>
        <result property="technologyActualNum" column="technology_actual_num"/>
        <result property="deviationInfo" column="deviation_info"/>
        <result property="elevel" column="elevel" />
    </resultMap>

    <update id="updateOrgInfoPaths">
UPDATE orginfo a
	INNER JOIN (
		SELECT org_id, parent_org_id, levels + 1 AS levels
			, concat(paths, ',', org_id) AS paths
		FROM (
			SELECT o.org_id, o.parent_org_id
				, @le := IF(o.parent_org_id = 0, 0, IF(LOCATE(CONCAT('|', o.parent_org_id, ':'), @pathlevel) > 0, SUBSTRING_INDEX(SUBSTRING_INDEX(@pathlevel, CONCAT('|', o.parent_org_id, ':'), -1), '|', 1) + 1, @le + 1)) AS levels
				, @pathlevel := CONCAT(@pathlevel, '|', o.org_id, ':', @le, '|') AS pathlevel
				, @pathnodes := IF(o.parent_org_id = 0, '0', CONCAT_WS(',', IF(LOCATE(CONCAT('|', o.parent_org_id, ':'), @pathall) > 0, SUBSTRING_INDEX(SUBSTRING_INDEX(@pathall, CONCAT('|', o.parent_org_id, ':'), -1), '|', 1), @pathnodes), o.parent_org_id)) AS paths
				, @pathall := CONCAT(@pathall, '|', o.org_id, ':', @pathnodes, '|') AS pathall
			FROM orginfo o, (
					SELECT @le := 0, @pathlevel := ''
						, @pathall := '', @pathnodes := ''
				) vv
			ORDER BY o.parent_org_id, o.org_id
		) src
		ORDER BY src.org_id
	) c
	ON a.org_id = c.org_id
SET a.levels = c.levels, a.paths = c.paths;
    </update>

    <select id="getOrgInfosByParentOrgId" resultType="com.sundata.edu.domain.Orginfo">
        SELECT org_id,org_name,parent_org_id,`status` FROM `orginfo` where `status`=1 AND find_in_set(#{parentOrgId},paths) order by levels
    </select>
    <select id="getOrgInfos" resultType="com.sundata.edu.domain.Orginfo">
        SELECT org_id,org_name,parent_org_id,`status` FROM `orginfo` where `status`=1 order by levels
    </select>
    <select id="selectList" resultType="com.sundata.edu.vo.OrginfoVo">
        SELECT * FROM `orginfo`
        <where>
            <if test="orgName!=null and orgName != ''">
                AND org_name like concat('%', #{orgName}, '%')
            </if>
            <if test="status!=null">
                AND status=#{status}
            </if>
        </where>
    </select>
    <select id="getOrgInfoByOrgName" resultType="com.sundata.edu.vo.IdTextItem">
        SELECT org_id as id,org_name as text FROM `orginfo` where `status`=1
        <if test="orgName!=null and orgName!=''">
            AND org_name like concat('%', #{orgName}, '%')
        </if>
    </select>


    <!--批量查找数据 -->
    <select id="selectbyorgidin" parameterType="java.util.ArrayList" resultMap="BaseResultMap">
        select * from orginfo
        <where>
            parent_org_id in (
            <foreach collection="list"  item="parentorgid" index="index" separator=",">
                #{parentorgid}
            </foreach>
            )
        </where>
    </select>


</mapper>